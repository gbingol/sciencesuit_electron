<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width">
	<title>Package Manager</title>
	<style>
		table, tr{
			border: 1px solid;
			border-collapse: collapse;
		}

		td{
			padding-top: 6px;
			padding-bottom: 6px;
			border: 1px solid;
		}

		tr:first-child{
			font-weight: bold;
		}

		tr:nth-child(2n+2){
			background-color: antiquewhite;
		}

		tr:nth-child(2n+1){
			background-color: blanchedalmond;
		}

		#erroutput{
			background-color: rgb(180, 76, 76);
		}
	</style>

	<script src="js/util.js"></script>
</head>


<body>
<script>
window.onload = (evt)=>
{
	document.querySelector("#version").innerHTML = 
		`Selected Python Version: <b>${localStorage.getItem("pyversion")}</b>`
}
</script>


<h1>Python Package Manager</h1>
<p id ="version"> </p>

<p><a href="index.html">Main Screen</a></p>


<button id="btnInstalled">Installed</button>
<button id="btnOutdated">Outdated</button>


<div id="modules"></div>
<div id="pipoutput"></div>



<script>
	"use strict"
	
	function DisableButtons(disable=true)
	{
		const AllBtns = document.body.getElementsByTagName("button");
		for(let b of AllBtns) 
			b.disabled=disable;
	}

	const btnOutdated = document.querySelector('#btnOutdated');
	btnOutdated.onclick = async function(evt)
	{
		const divModules = document.querySelector('#modules');
		divModules.innerHTML="Working on it, this might take some time...";

		let divPip = document.querySelector("#pipoutput");
		divPip.innerText="";

		let json="";
		try {
			DisableButtons();

			let cmd = "py -"+localStorage.getItem("pyversion") + " -m pip list -o --format=json "
			let output = await window.api.runcmd(cmd);
			json = JSON.parse(output);
		}
		catch(e) {
			divModules.innerText = e;
			return false;
		}
		
		let fragment = document.createDocumentFragment();

		let table = util.InitTable(fragment, ["Name", "Current", "Latest", ""]);

		for (let i = 0; i <json.length; i++) 
		{
			let e = json[i];

			let row = table.appendChild(document.createElement("tr"));
			let col1 = row.appendChild(document.createElement("td"));
			col1.innerHTML=e.name ;
			let col2 = row.appendChild(document.createElement("td"));
			col2.innerHTML=e.version;
			let col3 = row.appendChild(document.createElement("td"));
			col3.innerHTML=e.latest_version;

			let col4 = row.appendChild(document.createElement("td"));
			let btnUpgrade = col4.appendChild(document.createElement("button"));
			btnUpgrade.id = "upgrade_"+e.name;
			btnUpgrade.innerHTML="Upgrade";
			
			table.appendChild(row);

			
			btnUpgrade.onclick = async (evt)=>
			{
				try {
					DisableButtons();
					divPip.innerText="";

					let UpgradeCmd = "py -"+localStorage.getItem("pyversion") + 
						" -m pip install --upgrade " + e.name;
					let output = await window.api.runcmd(UpgradeCmd);
					divPip.scrollIntoView();
					divPip.innerText=output;

					DisableButtons(false);
				}
				catch(error) {
					divPip.scrollIntoView();
					divPip.innerText=error;
				}
			}

			DisableButtons(false);
		}

		divModules.innerHTML="";
		divModules.appendChild(fragment)
	}




	const btnInstalled = document.querySelector('#btnInstalled');
	btnInstalled.onclick = async function(evt)
	{
		const divModules = document.querySelector('#modules');
		divModules.innerHTML="Working on it...";

		let divPip = document.querySelector("#pipoutput");
		divPip.innerText="";

		let json="";
		try {
			DisableButtons();

			let cmd = "py -"+localStorage.getItem("pyversion") + " -m pip list --format=json "
			let output = await window.api.runcmd(cmd);
			json = JSON.parse(output);
		}
		catch(e) {
			divModules.innerText = e;
			return false;
		}
		
		let fragment = document.createDocumentFragment();

		let table = util.InitTable(fragment, ["Name", "Version", ""]);

		for (let i = 0; i <json.length; i++) 
		{
			let e = json[i];

			let row = table.appendChild(document.createElement("tr"));
			let col1 = row.appendChild(document.createElement("td"));
			col1.innerHTML=e.name ;
			let col2 = row.appendChild(document.createElement("td"));
			col2.innerHTML=e.version;
			let col3 = row.appendChild(document.createElement("td"));
			let btnInfo = col3.appendChild(document.createElement("button"));
			btnInfo.id = "info_"+e.name;
			btnInfo.innerHTML="Info";

			let btnRemove = col3.appendChild(document.createElement("button"));
			btnRemove.id = "remove_"+e.name;
			btnRemove.innerHTML="Uninstall";
			
			table.appendChild(row);

			
			btnInfo.onclick = async (evt)=>
			{
				try {
					DisableButtons();
					divPip.innerText="";

					let ShowCmd = "py -"+localStorage.getItem("pyversion") + 
						" -m pip show " + e.name;
					let output = await window.api.runcmd(ShowCmd);
					divPip.scrollIntoView();
					divPip.innerText=output;

					DisableButtons(false);
				}
				catch(error) {
					divPip.scrollIntoView();
					divPip.innerText=error;
				}
			}

			btnRemove.onclick = async (evt)=>
			{
				try {
					divPip.innerText = "";
						
					DisableButtons();

					let remCmd = "py -"+ localStorage.getItem("pyversion") + 
						" -m pip uninstall -y " + e.name;

					let output = await window.api.runcmd(remCmd);
					divPip.scrollIntoView();
					divPip.innerText = output;

					DisableButtons(false);
				}		
				catch(error) {
					divPip.scrollIntoView();
					divPip.innerText=error;

					DisableButtons(false);
				}
			}

			DisableButtons(false);
		}

		divModules.innerHTML="";
		divModules.appendChild(fragment)
	}

</script>

</body>
</html>